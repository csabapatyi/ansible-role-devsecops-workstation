---
#------------------------------------------------------------------------------
# GitHub Actions CI Pipeline for DevSecOps Workstation Role
#------------------------------------------------------------------------------
name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  schedule:
    # Run weekly on Sundays at midnight
    - cron: "0 0 * * 0"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  #----------------------------------------------------------------------------
  # Lint Job - Check syntax and style
  #----------------------------------------------------------------------------
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core ansible-lint yamllint

      - name: Run yamllint
        run: |
          yamllint -c .yamllint.yml . || true

      - name: Run ansible-lint
        run: |
          ansible-lint --force-color

  #----------------------------------------------------------------------------
  # Molecule Test Jobs - Run tests on each platform separately for badges
  #----------------------------------------------------------------------------
  test-ubuntu-2404:
    name: Ubuntu 24.04
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r molecule/requirements.txt

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install community.general ansible.posix community.docker

      - name: Run Molecule tests
        run: |
          molecule test --scenario-name default --platform-name ubuntu-2404
        env:
          PY_COLORS: "1"
          ANSIBLE_FORCE_COLOR: "1"
          ANSIBLE_STDOUT_CALLBACK: "ansible.builtin.default"

  test-ubuntu-2510:
    name: Ubuntu 25.10
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r molecule/requirements.txt

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install community.general ansible.posix community.docker

      - name: Run Molecule tests
        run: |
          molecule test --scenario-name default --platform-name ubuntu-2510
        env:
          PY_COLORS: "1"
          ANSIBLE_FORCE_COLOR: "1"
          ANSIBLE_STDOUT_CALLBACK: "ansible.builtin.default"

  test-fedora-42:
    name: Fedora 42
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r molecule/requirements.txt

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install community.general ansible.posix community.docker

      - name: Run Molecule tests
        run: |
          molecule test --scenario-name default --platform-name fedora-42
        env:
          PY_COLORS: "1"
          ANSIBLE_FORCE_COLOR: "1"
          ANSIBLE_STDOUT_CALLBACK: "ansible.builtin.default"

  test-fedora-43:
    name: Fedora 43
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r molecule/requirements.txt

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install community.general ansible.posix community.docker

      - name: Run Molecule tests
        run: |
          molecule test --scenario-name default --platform-name fedora-43
        env:
          PY_COLORS: "1"
          ANSIBLE_FORCE_COLOR: "1"
          ANSIBLE_STDOUT_CALLBACK: "ansible.builtin.default"

  test-archlinux:
    name: Arch Linux
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r molecule/requirements.txt

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install community.general ansible.posix community.docker

      - name: Run Molecule tests
        run: |
          molecule test --scenario-name default --platform-name archlinux
        env:
          PY_COLORS: "1"
          ANSIBLE_FORCE_COLOR: "1"
          ANSIBLE_STDOUT_CALLBACK: "ansible.builtin.default"

  test-opensuse:
    name: openSUSE Tumbleweed
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r molecule/requirements.txt

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install community.general ansible.posix community.docker

      - name: Run Molecule tests
        run: |
          molecule test --scenario-name default --platform-name opensuse-tumbleweed
        env:
          PY_COLORS: "1"
          ANSIBLE_FORCE_COLOR: "1"
          ANSIBLE_STDOUT_CALLBACK: "ansible.builtin.default"

  #----------------------------------------------------------------------------
  # Release Job - Publish to Ansible Galaxy
  #----------------------------------------------------------------------------
  release:
    name: Release to Galaxy
    runs-on: ubuntu-latest
    needs:
      - test-ubuntu-2404
      - test-ubuntu-2510
      - test-fedora-42
      - test-fedora-43
      - test-archlinux
      - test-opensuse
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Ansible
        run: pip install ansible-core

      - name: Import role to Ansible Galaxy
        run: |
          ansible-galaxy role import --api-key ${{ secrets.GALAXY_API_KEY }} \
            $(echo ${{ github.repository }} | cut -d/ -f1) \
            $(echo ${{ github.repository }} | cut -d/ -f2)
        if: ${{ env.GALAXY_API_KEY != '' }}
        env:
          GALAXY_API_KEY: ${{ secrets.GALAXY_API_KEY }}
