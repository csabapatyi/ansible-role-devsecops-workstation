---
# 1. Install System Packages based on OS Family
- name: Install system packages (Debian/Ubuntu)
  apt:
    name: "{{ system_packages }}"
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"
  become: true

- name: Install system packages (Fedora)
  dnf:
    name: "{{ system_packages }}"
    state: present
    update_cache: yes
  when: ansible_os_family == "RedHat"
  become: true

- name: Install system packages (openSUSE)
  zypper:
    name: "{{ system_packages }}"
    state: present
    update_cache: yes
  when: ansible_os_family == "Suse"
  become: true

# 2. Install Packages directly from URLs
# This is useful for tools that don't provide repos (e.g. specific binary releases)
- name: Ensure destination directory for URL downloads exists
  file:
    path: "{{ item.dest | dirname }}"
    state: directory
    mode: '0755'
  loop: "{{ url_packages }}"
  when: url_packages | length > 0
  become: true

- name: Download and install packages from URL
  get_url:
    url: "{{ item.url }}"
    dest: "{{ item.dest }}"
    mode: '0755'
  loop: "{{ url_packages }}"
  when: url_packages | length > 0
  become: true

# 3. Install AppImages
# We usually store these in a dedicated bin folder in the user's home
- name: Create AppImage directory
  file:
    path: "/home/{{ workstation_user }}/Applications"
    state: directory
    owner: "{{ workstation_user }}"
    group: "{{ workstation_user }}"
    mode: '0755'

- name: Download AppImages
  get_url:
    url: "{{ item.url }}"
    dest: "/home/{{ workstation_user }}/Applications/{{ item.name }}.AppImage"
    owner: "{{ workstation_user }}"
    group: "{{ workstation_user }}"
    mode: '0755'
  loop: "{{ appimage_packages }}"
  when: appimage_packages | length > 0

# 4. Install VS Code via system repo (if chosen)
- name: Install VS Code via Package Manager
  package:
    name: "{{ vscode_package_name }}"
    state: present
  when: vscode_install_method == "repo"
  become: true

# GitHub CLI
- name: Install GitHub CLI
  package:
    name: gh
    state: present
  when: install_github_cli
  become: true

# GitLab CLI
- name: Install GitLab CLI
  package:
    name: glab
    state: present
  when: install_gitlab_cli
  become: true

# 1. Google Cloud CLI (Script-based with check)
- name: Check if Google Cloud SDK is already installed
  stat:
    path: /opt/google-cloud-sdk
  register: gcp_sdk_dir

- name: Install Google Cloud CLI via Script
  shell: curl https://sdk.cloud.google.com | bash -s -- --disable-prompts --install-dir=/opt
  when:
    - install_gcp_cli
    - not gcp_sdk_dir.stat.exists
  become: true

# 2. AWS CLI v2 (Check then Install)
- name: Check if AWS CLI is installed
  command: which aws
  register: aws_check
  ignore_errors: true
  changed_when: false

- name: Install AWS CLI v2
  block:
    - name: Download AWS CLI
      unarchive:
        src: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
        dest: /tmp
        remote_src: true
    - name: Run AWS Installer
      command: /tmp/aws/install --update
  when:
    - install_aws_cli
    - aws_check.rc != 0
  become: true

# 3. AWS SSM Session Manager Plugin (Validation-based)
- name: Check if SSM Session Manager Plugin is installed
  shell: session-manager-plugin --version
  register: ssm_plugin_check
  ignore_errors: true
  changed_when: false

- name: Install AWS SSM Session Manager Plugin (Debian/Ubuntu)
  apt:
    deb: "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb"
    state: present
  when:
    - install_aws_cli
    - ansible_os_family == "Debian"
    - ssm_plugin_check.rc != 0
  become: true

- name: Install AWS SSM Session Manager Plugin (Fedora/RedHat)
  dnf:
    name: "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm"
    state: present
    disable_gpg_check: true
  when:
    - install_aws_cli
    - ansible_os_family == "RedHat"
    - ssm_plugin_check.rc != 0
  become: true

- name: Install AWS SSM Session Manager Plugin (openSUSE)
  zypper:
    name: "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm"
    state: present
    disable_gpg_check: true
  when:
    - install_aws_cli
    - ansible_os_family == "Suse"
    - ssm_plugin_check.rc != 0
  become: true

# Azure CLI (Check then Install)
- name: Check if Azure CLI is installed
  command: which az
  register: az_check
  ignore_errors: true
  changed_when: false

- name: Install Azure CLI (Debian/Ubuntu)
  shell: curl -sL https://aka.ms/InstallAzureCLIDeb | bash
  when:
    - install_azure_cli
    - ansible_os_family == "Debian"
    - az_check.rc != 0
  become: true

- name: Install Azure CLI (Fedora/RedHat)
  shell: rpm --import https://packages.microsoft.com/keys/microsoft.asc && dnf install -y https://packages.microsoft.com/config/fedora/$(rpm -E %fedora)/packages-microsoft-prod.rpm && dnf install -y azure-cli
  when:
    - install_azure_cli
    - ansible_os_family == "RedHat"
    - az_check.rc != 0
  become: true

# Neovim (Check then Install Binary)
- name: Check if Neovim is installed
  command: which nvim
  register: nvim_check
  ignore_errors: true
  changed_when: false

- name: Install Neovim Stable
  block:
    - name: Download and Extract Nvim Binary
      unarchive:
        src: https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.tar.gz
        dest: /opt
        remote_src: true
        owner: root
        group: root

    - name: Link Nvim to Path
      file:
        src: /opt/nvim-linux-x86_64/bin/nvim
        dest: /usr/local/bin/nvim
        state: link
        force: true
  when:
    - nvim_check.rc != 0
    - ("'nvim' in system_packages") or (install_neovim | default(true))
  become: true