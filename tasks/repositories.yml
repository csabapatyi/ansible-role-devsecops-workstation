---
# ------------------------------------------------------------------------------
# Repository Configuration
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# 1. Install repository packages from URLs (keyrings, etc.)
#    These must be installed BEFORE adding repos that depend on them
# ------------------------------------------------------------------------------
- name: Install direct .deb packages from URL (Debian)
  ansible.builtin.apt:
    deb: "{{ item }}"
    state: present
  loop: "{{ direct_deb_urls }}"
  when:
    - ansible_facts['os_family'] == "Debian"
    - direct_deb_urls | length > 0
  become: true

- name: Install direct .rpm packages from URL (Fedora)
  ansible.builtin.dnf:
    name: "{{ item }}"
    state: present
    disable_gpg_check: true
  loop: "{{ direct_rpm_urls }}"
  when:
    - ansible_facts['os_family'] == "RedHat"
    - direct_rpm_urls | length > 0
  become: true

- name: Install direct .rpm packages from URL (openSUSE)
  community.general.zypper:
    name: "{{ item }}"
    state: present
    disable_gpg_check: true
  loop: "{{ direct_zypper_urls }}"
  when:
    - ansible_facts['os_family'] == "Suse"
    - direct_zypper_urls | length > 0
  become: true

# ------------------------------------------------------------------------------
# 2. Add Ubuntu/Pop!_OS PPAs
# ------------------------------------------------------------------------------
- name: Add custom PPAs (Debian/Ubuntu only)
  ansible.builtin.apt_repository:
    repo: "{{ item }}"
    state: present
    update_cache: false
  loop: "{{ custom_ppas }}"
  when:
    - ansible_facts['os_family'] == "Debian"
    - custom_ppas | length > 0
  become: true
  register: ppa_added

# ------------------------------------------------------------------------------
# 3. Add custom repositories with GPG keys
# ------------------------------------------------------------------------------

# Debian/Ubuntu: Download and convert GPG keys
- name: Download custom GPG keys (Debian)
  ansible.builtin.get_url:
    url: "{{ item.gpg_key }}"
    dest: "/usr/share/keyrings/{{ item.name }}-archive-keyring.asc"
    mode: "0644"
  loop: "{{ custom_repositories }}"
  when:
    - ansible_facts['os_family'] == "Debian"
    - item.gpg_key is defined
    - item.apt_repo is defined
  become: true

- name: Convert GPG keys to binary format (Debian)
  ansible.builtin.shell: |
    gpg --dearmor < /usr/share/keyrings/{{ item.name }}-archive-keyring.asc > /usr/share/keyrings/{{ item.name }}-archive-keyring.gpg
  args:
    creates: "/usr/share/keyrings/{{ item.name }}-archive-keyring.gpg"
  loop: "{{ custom_repositories }}"
  when:
    - ansible_facts['os_family'] == "Debian"
    - item.gpg_key is defined
    - item.apt_repo is defined
  become: true

- name: Add custom APT repositories (Debian)
  ansible.builtin.apt_repository:
    repo: "{{ item.apt_repo }}"
    state: present
    filename: "{{ item.name }}"
    update_cache: false
  loop: "{{ custom_repositories }}"
  when:
    - ansible_facts['os_family'] == "Debian"
    - item.apt_repo is defined
  become: true
  register: apt_repo_added

# Fedora/RHEL: Add DNF repositories
- name: Add custom DNF repositories (Fedora)
  ansible.builtin.yum_repository:
    name: "{{ item.name }}"
    description: "{{ item.name }} repository"
    baseurl: "{{ item.yum_repo }}"
    gpgkey: "{{ item.gpg_key | default(omit) }}"
    gpgcheck: "{{ 'yes' if item.gpg_key is defined else 'no' }}"
  loop: "{{ custom_repositories }}"
  when:
    - ansible_facts['os_family'] == "RedHat"
    - item.yum_repo is defined
  become: true

# openSUSE: Add Zypper repositories
- name: Add custom Zypper repositories (openSUSE)
  community.general.zypper_repository:
    name: "{{ item.name }}"
    repo: "{{ item.zypper_repo | default(item.yum_repo) }}"
    state: present
    auto_import_keys: true
  loop: "{{ custom_repositories }}"
  when:
    - ansible_facts['os_family'] == "Suse"
    - item.yum_repo is defined or item.zypper_repo is defined
  become: true

# ------------------------------------------------------------------------------
# 4. Docker Repository (when container_engine == "docker")
# ------------------------------------------------------------------------------
- name: Configure Docker repository (Debian)
  when:
    - ansible_facts['os_family'] == "Debian"
    - container_engine == "docker"
  become: true
  block:
    - name: Download Docker GPG key
      ansible.builtin.get_url:
        url: "{{ docker_gpg_key }}"
        dest: /usr/share/keyrings/docker-archive-keyring.asc
        mode: "0644"

    - name: Convert Docker GPG key to binary format
      ansible.builtin.shell: |
        gpg --dearmor < /usr/share/keyrings/docker-archive-keyring.asc > /usr/share/keyrings/docker-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/docker-archive-keyring.gpg

    - name: Add Docker Repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] {{ docker_repo_url }} {{ ansible_facts['distribution_release'] }} stable"
        state: present
        filename: docker
        update_cache: false
      register: docker_repo_added

- name: Configure Docker repository (Fedora/openSUSE)
  ansible.builtin.get_url:
    url: "{{ docker_repo_url_default }}"
    dest: /etc/yum.repos.d/docker-ce.repo
    mode: "0644"
  when:
    - ansible_facts['os_family'] in ["RedHat", "Suse"]
    - container_engine == "docker"
  become: true

# ------------------------------------------------------------------------------
# 5. VS Code Repository (when vscode_install_method == "repo")
# ------------------------------------------------------------------------------
- name: Configure VS Code repository (Debian)
  when:
    - ansible_facts['os_family'] == "Debian"
    - vscode_install_method == "repo"
  become: true
  block:
    - name: Download VS Code GPG key
      ansible.builtin.get_url:
        url: "{{ vscode_repo_key }}"
        dest: /usr/share/keyrings/microsoft.asc
        mode: "0644"

    - name: Convert VS Code GPG key to binary format
      ansible.builtin.shell: |
        gpg --dearmor < /usr/share/keyrings/microsoft.asc > /usr/share/keyrings/microsoft.gpg
      args:
        creates: /usr/share/keyrings/microsoft.gpg

    - name: Add VS Code Repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft.gpg] {{ vscode_repo_url }} stable main"
        state: present
        filename: vscode
        update_cache: false
      register: vscode_repo_added

- name: Configure VS Code repository (Fedora/openSUSE)
  ansible.builtin.yum_repository:
    name: vscode
    description: Visual Studio Code
    baseurl: "{{ vscode_repo_url_default }}"
    gpgkey: "{{ vscode_repo_key_default }}"
    gpgcheck: true
  when:
    - ansible_facts['os_family'] in ["RedHat", "Suse"]
    - vscode_install_method == "repo"
  become: true

# ------------------------------------------------------------------------------
# 6. Update package cache after adding repositories
# ------------------------------------------------------------------------------
- name: Update apt cache (Debian)
  ansible.builtin.apt:
    update_cache: true
  when:
    - ansible_facts['os_family'] == "Debian"
    - (ppa_added.changed | default(false)) or
      (apt_repo_added.changed | default(false)) or
      (docker_repo_added.changed | default(false)) or
      (vscode_repo_added.changed | default(false))
  become: true
