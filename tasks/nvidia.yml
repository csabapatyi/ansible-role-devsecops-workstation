---
# Nvidia Driver Installation

# 1. Determine which packages to install
- name: Set Nvidia packages to install
  ansible.builtin.set_fact:
    nvidia_packages_to_install: >-
      {{
        nvidia_packages if (nvidia_packages | length > 0)
        else (nvidia_default_packages[nvidia_driver_type] | default([]))
      }}

- name: Display Nvidia packages to be installed
  ansible.builtin.debug:
    msg: |
      Nvidia Driver Type: {{ nvidia_driver_type }}
      Packages to install: {{ nvidia_packages_to_install }}

# 2. Fedora-specific: Enable RPM Fusion Nvidia repo
- name: Enable RPM Fusion Nvidia repository (Fedora)
  ansible.builtin.command: dnf config-manager --set-enabled rpmfusion-nonfree-nvidia-driver
  when: ansible_facts['os_family'] == "RedHat"
  become: true
  failed_when: false
  changed_when: false

# 3. openSUSE-specific: Add Nvidia repository
- name: Add Nvidia repository (openSUSE)
  community.general.zypper_repository:
    name: nvidia
    repo: "https://download.nvidia.com/opensuse/tumbleweed"
    state: present
    auto_import_keys: true
  when: ansible_facts['os_family'] == "Suse"
  become: true

# 4. Arch-specific: Ensure multilib is enabled (for 32-bit libs)
- name: Ensure multilib repository is enabled (Arch)
  ansible.builtin.lineinfile:
    path: /etc/pacman.conf
    regexp: '^\[multilib\]'
    line: "[multilib]"
    state: present
  when: ansible_facts['os_family'] == "Archlinux"
  become: true
  notify: Update pacman cache

# 5. Install Nvidia drivers
- name: Fail if no Nvidia packages defined
  ansible.builtin.fail:
    msg: |
      No Nvidia packages defined for {{ ansible_facts['distribution'] }}.
      Please set 'nvidia_packages' in your extra-vars file.
      Example:
        nvidia_packages:
          - nvidia-driver-560
          - nvidia-utils-560
          - nvidia-settings
  when: nvidia_packages_to_install | length == 0

- name: Install Nvidia drivers (Debian)
  ansible.builtin.apt:
    name: "{{ nvidia_packages_to_install }}"
    state: present
    update_cache: true
  when: ansible_facts['os_family'] == "Debian"
  become: true
  notify: Nvidia drivers installed

- name: Install Nvidia drivers (Fedora)
  ansible.builtin.dnf:
    name: "{{ nvidia_packages_to_install }}"
    state: present
  when: ansible_facts['os_family'] == "RedHat"
  become: true
  notify: Nvidia drivers installed

- name: Install Nvidia drivers (openSUSE)
  community.general.zypper:
    name: "{{ nvidia_packages_to_install }}"
    state: present
  when: ansible_facts['os_family'] == "Suse"
  become: true
  notify: Nvidia drivers installed

- name: Install Nvidia drivers (Arch)
  community.general.pacman:
    name: "{{ nvidia_packages_to_install }}"
    state: present
  when: ansible_facts['os_family'] == "Archlinux"
  become: true
  notify: Nvidia drivers installed
