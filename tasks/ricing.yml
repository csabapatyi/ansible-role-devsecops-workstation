---
# Ricing: Fonts, Dotfiles, and Customization

# 1. Install Nerd Fonts
- name: Install Nerd Fonts
  when: nerd_font_urls | length > 0
  become: true
  become_user: "{{ workstation_user }}"
  block:
    - name: Ensure local fonts directory exists
      ansible.builtin.file:
        path: "/home/{{ workstation_user }}/.local/share/fonts"
        state: directory
        owner: "{{ workstation_user }}"
        group: "{{ workstation_user }}"
        mode: "0755"

    - name: Download Nerd Font zip files
      ansible.builtin.get_url:
        url: "{{ item }}"
        dest: "/home/{{ workstation_user }}/.local/share/fonts/{{ item | basename }}"
        mode: "0644"
      loop: "{{ nerd_font_urls }}"
      register: fonts_downloaded

    - name: Unarchive newly downloaded Nerd Fonts
      ansible.builtin.unarchive:
        src: "/home/{{ workstation_user }}/.local/share/fonts/{{ item.item | basename }}"
        dest: "/home/{{ workstation_user }}/.local/share/fonts"
        remote_src: true
      loop: "{{ fonts_downloaded.results }}"
      when: item.changed
      register: fonts_extracted

    - name: Update font cache
      ansible.builtin.command: fc-cache -f
      when: fonts_extracted.results | default([]) | selectattr('changed', 'defined') | selectattr('changed') | list | length > 0
      changed_when: true

# 2. Clone Dotfiles Repository
- name: Clone dotfiles repository
  when: dotfiles_repo | length > 0
  become: true
  become_user: "{{ workstation_user }}"
  block:
    - name: Ensure dotfiles parent directory exists
      ansible.builtin.file:
        path: "{{ (dotfiles_dest | expanduser) | dirname }}"
        state: directory
        owner: "{{ workstation_user }}"
        group: "{{ workstation_user }}"
        mode: "0755"

    - name: Clone dotfiles
      ansible.builtin.git:
        repo: "{{ dotfiles_repo }}"
        dest: "{{ dotfiles_dest | expanduser }}"
        version: "{{ dotfiles_version | default('main') }}"
        accept_hostkey: true
        force: false
      register: dotfiles_cloned

    - name: Display dotfiles location
      ansible.builtin.debug:
        msg: |
          Dotfiles cloned to: {{ dotfiles_dest | expanduser }}
          You may need to run your dotfiles setup script manually.
      when: dotfiles_cloned.changed
