---
# 1. Install Nerd Fonts from list of URLs
- name: Install Nerd Fonts
  block:
    - name: Ensure local fonts directory exists
      file:
        path: "/home/{{ workstation_user }}/.local/share/fonts"
        state: directory
        owner: "{{ workstation_user }}"
        group: "{{ workstation_user }}"
        mode: '0755'

    - name: Download and unarchive Nerd Fonts
      unarchive:
        src: "{{ item }}"
        dest: "/home/{{ workstation_user }}/.local/share/fonts"
        remote_src: true
      loop: "{{ nerd_font_urls }}"
      when: nerd_font_urls | length > 0

    - name: Update font cache
      command: fc-cache -f
      changed_when: true
  when: nerd_font_urls | length > 0
  become: true
  become_user: "{{ workstation_user }}"

# 2. Dotfiles
- name: Clone dotfiles repository
  git:
    repo: "{{ dotfiles_repo }}"
    dest: "{{ dotfiles_dest | expanduser }}"
    accept_hostkey: true
  when: dotfiles_repo != ""
  become: true
  become_user: "{{ workstation_user }}"

# 3. Inject Custom Shell Configuration Block
# If you choose /usr/bin/fish, the RC file path is different. Conditional check needed to handle this.
- name: Determine Shell RC path
  set_fact:
    shell_rc_path: >-
      {% if 'fish' in workstation_user_shell -%}
      /home/{{ workstation_user }}/.config/fish/config.fish
      {%- else -%}
      /home/{{ workstation_user }}/.{{ workstation_user_shell | basename }}rc
      {%- endif %}

- name: Ensure Fish config directory exists
  file:
    path: "/home/{{ workstation_user }}/.config/fish"
    state: directory
  when: "'fish' in workstation_user_shell"
  become: true
  become_user: "{{ workstation_user }}"

- name: Inject custom content into shell RC
  blockinfile:
    path: "{{ shell_rc_path }}"
    marker: "# {mark} ANSIBLE MANAGED BLOCK: Custom Shell Settings"
    block: "{{ custom_shell_content }}"
    create: true
    owner: "{{ workstation_user }}"
    group: "{{ workstation_user }}"
    mode: '0644'
  when: custom_shell_content | length > 0
  become: true
  become_user: "{{ workstation_user }}"