---
# 1. Check if cargo binary exists in the user's home (rustup standard)
- name: Check for rustup cargo binary
  stat:
    path: "/home/{{ workstation_user }}/.cargo/bin/cargo"
  register: cargo_bin

# 2. Install Rust via rustup if the binary is missing
- name: Install Rust via rustup
  block:
    - name: Download rustup installer
      get_url:
        url: https://sh.rustup.rs
        dest: /tmp/rustup.sh
        mode: '0755'

    - name: Run rustup installer
      shell: /tmp/rustup.sh -y
      become: true
      become_user: "{{ workstation_user }}"
  when: not cargo_bin.stat.exists

# 3. Install Cargo Packages
# Instead of 'source', we provide the full path to the cargo binary
- name: Install Rust packages via Cargo
  shell: "/home/{{ workstation_user }}/.cargo/bin/cargo install {{ item }}"
  loop: "{{ rust_cargo_packages }}"
  when: rust_cargo_packages | length > 0
  become: true
  become_user: "{{ workstation_user }}"
  register: cargo_install_result
  changed_when: "'Installing' in cargo_install_result.stderr"
  vars:
    ansible_command_timeout: 1200

# 4. Ensure Cargo bin is in the user's PATH via .profile or .bashrc
- name: Ensure Cargo bin is in .profile
  lineinfile:
    path: "/home/{{ workstation_user }}/.profile"
    line: 'export PATH="$HOME/.cargo/bin:$PATH"'
    create: true
    state: present
  become: true
  become_user: "{{ workstation_user }}"