# Molecule Dockerfile for openSUSE Tumbleweed
# Supports openSUSE Tumbleweed
FROM {{ item.image }}

ENV container=docker
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# Install systemd and essential packages
RUN zypper --non-interactive refresh && \
    zypper --non-interactive install \
    systemd \
    python3 \
    python3-pip \
    sudo \
    bash \
    ca-certificates \
    curl \
    gpg2 \
    iproute2 \
    which \
    gzip \
    tar \
    && zypper clean --all

# Remove unnecessary systemd services that cause issues in containers
RUN (cd /usr/lib/systemd/system/sysinit.target.wants/; for i in *; do [ $i == systemd-tmpfiles-setup.service ] || rm -f $i; done); \
    rm -f /usr/lib/systemd/system/multi-user.target.wants/*; \
    rm -f /etc/systemd/system/*.wants/*; \
    rm -f /usr/lib/systemd/system/local-fs.target.wants/*; \
    rm -f /usr/lib/systemd/system/sockets.target.wants/*udev*; \
    rm -f /usr/lib/systemd/system/sockets.target.wants/*initctl*; \
    rm -f /usr/lib/systemd/system/basic.target.wants/*; \
    rm -f /usr/lib/systemd/system/anaconda.target.wants/* 2>/dev/null || true

# Fix PAM configuration for container environment
# Disable pam_systemd.so and pam_loginuid.so which cause issues in containers
RUN for f in /etc/pam.d/common-session /etc/pam.d/su /etc/pam.d/sudo /etc/pam.d/common-auth; do \
        if [ -f "$f" ]; then \
            sed -i 's/^\(.*pam_systemd.so.*\)$/#\1/' "$f" 2>/dev/null || true; \
            sed -i 's/^\(.*pam_loginuid.so.*\)$/#\1/' "$f" 2>/dev/null || true; \
        fi; \
    done

# Create /etc/sudoers if it doesn't exist (openSUSE Tumbleweed minimal may not have it)
# Also ensure sudoers.d directory exists
RUN if [ ! -f /etc/sudoers ]; then \
        echo "# Sudoers file created for container testing" > /etc/sudoers && \
        echo "root ALL=(ALL) ALL" >> /etc/sudoers && \
        echo "@includedir /etc/sudoers.d" >> /etc/sudoers && \
        chmod 0440 /etc/sudoers; \
    fi && \
    mkdir -p /etc/sudoers.d

# Disable requiretty and visiblepw in main sudoers if present
RUN sed -i 's/^Defaults.*requiretty/# Defaults requiretty/' /etc/sudoers 2>/dev/null || true \
    && sed -i 's/^Defaults.*!visiblepw/# Defaults !visiblepw/' /etc/sudoers 2>/dev/null || true

# Create test user with password and passwordless sudo
# Note: requiretty option removed as it's deprecated in newer sudo versions
RUN useradd -m -s /bin/bash testuser \
    && echo "testuser:testpass" | chpasswd \
    && echo "testuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/testuser \
    && chmod 0440 /etc/sudoers.d/testuser

# Verify sudoers configuration is valid
RUN visudo -cf /etc/sudoers \
    && visudo -cf /etc/sudoers.d/testuser

VOLUME ["/sys/fs/cgroup"]
CMD ["/usr/lib/systemd/systemd"]
